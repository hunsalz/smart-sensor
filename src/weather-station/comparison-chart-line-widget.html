<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/app-storage/app-localstorage/app-localstorage-document.html">

<link rel="import" href="../../bower_components/chart-elements/chart-line.html">

<dom-module id="comparison-chart-line-widget">
  <template>
    <style>
      :host {
        display: inline-block;
      }
      chart-line {
        width: 100%;
        height: 100%;
      }
      .last-updated {
        font-size: 0.75em;
        font-weight: 400;
        color: grey;
        text-align: center;
        padding-top: 10px;
        padding-bottom: 10px;
      }
    </style>
    <div class="last-updated">
      <div>Last updated A on [[_getDatetime(lastMessage1.parsedPayload.timestamp)]]</div>
      <div>Last updated B on [[_getDatetime(lastMessage2.parsedPayload.timestamp)]]</div>
    </div>
    <chart-line id="chart_id" data="[[_chart]]" options="[[_options]]"></chart-line>
    <app-localstorage-document key="{{id}}" data="{{_data}}" log></app-localstorage-document>
  </template>
  <script>
    Polymer({
      is: 'comparison-chart-line-widget',
      properties: {
        id: {
          type: String,
          value: null
        },
        label1: {
          type: String,
          value: null
        },
        label2: {
          type: String,
          value: null
        },
        lastMessage1: {
          type: Object,
          value: null,
          notify: true,
          observer: 'processMessage1'
        },
        property1: {
          type: String,
          value: null
        },
        property2: {
          type: String,
          value: null
        },
        lastMessage2: {
          type: Object,
          value: null,
          notify: true,
          observer: 'processMessage2'
        },
        _data: {
          type: Object,
          value: function() {
            return {
              labels: [],
              value1: [],
              value2: []
            };
          },
          notify: true
        },
        _chart: {
          type: Object,
          value: function() {
            return {
              labels: [],
              datasets: [{
                label: null,
                fill: true,
                backgroundColor: "rgba(220,220,220,0.2)",
                borderColor: "rgba(220,220,220,1)",
                borderWidth: 1,
                data: []
              },
              {
                label: null,
                fill: true,
                backgroundColor: "rgba(151,187,205,0.2)",
                borderColor: "rgba(151,187,205,1)",
                borderWidth: 1,
                data: []
              }]
            };
          }
        },
        _options: {
          type: Object,
          value: {
            responsive: true,
            legend: {
              display: true,
              position: 'bottom'
            }
          }
        },
        max_chart_view: {
          type: Number,
          value: 5
        },
        /**
         * when true perform detail logging
         */
        log: {
          type: Boolean,
          value: true
        }
      },
      attached: function() {
        // link properies and chart representation together
        this._chart.datasets[0].label = this.label1;
        this._chart.datasets[1].label = this.label2;
        this._chart.labels = this._data.labels;
        this._chart.datasets[0].data = this._data.value1;
        this._chart.datasets[1].data = this._data.value2;
      },
      processMessage1: function(event) {
        if (event) {
          var json = event.parsedPayload;
          var label = this._formatTimestamp(json.timestamp);
          var index = this._adjustXAxis(label);
          // assign new value
          this._data.value1[index] = json[this.property1];
          // update chart
          this.$.chart_id.updateChart();
          // force data system to pick up array mutations; necessary to force locale storage updates
          // see https://www.polymer-project.org/1.0/docs/devguide/model-data#override-dirty-check
          var array = this._data;
          this._data = [];
          this._data = array;

          //this._log("updateMessage 1", this._data.labels);
          //this._log("updateMessage 1", this._data.value1);
          //this._log("updateMessage 1", this._data.value2);
        }
      },
      processMessage2: function(event) {
        if (event) {
          var json = event.parsedPayload;
          var label = this._formatTimestamp(json.timestamp);
          var index = this._adjustXAxis(label);
          // assign new value
          this._data.value2[index] = json[this.property2];
          // update chart
          this.$.chart_id.updateChart();
          // force data system to pick up array mutations; necessary to force locale storage updates
          // see https://www.polymer-project.org/1.0/docs/devguide/model-data#override-dirty-check
          var array = this._data;
          this._data = [];
          this._data = array;

          //this._log("updateMessage 2", this._data.labels);
          //this._log("updateMessage 2", this._data.value1);
          //this._log("updateMessage 2", this._data.value2);
        }
      },
      _adjustXAxis: function(label) {
        var index = this._data.labels.lastIndexOf(label);
        // add new label if label isn't assigend so far
        if (index === -1) {
          this._data.labels.push(label);
          // continue data values linear with latest known values
          this._data.value1.push(this._data.value1[this._data.value1.length - 1]);
          this._data.value2.push(this._data.value2[this._data.value2.length - 1]);
          // if max chart view is reached, shrink arrays at the beginning
          if (this._data.labels.length > this.max_chart_view) {
            this._data.labels.shift();
            this._data.value1.shift();
            this._data.value2.shift();
          }
          index = this._data.labels.length - 1;
        }
        // return label position
        return index;
      },
      _getDatetime: function(timestamp) {
        return new Date(timestamp * 1000);
      },
      _formatTimestamp: function(timestamp) {
        var value = new Date(timestamp * 1000);
        return [this._pad(value.getHours()), this._pad(value.getMinutes()), this._pad(value.getSeconds())].join(':');
      },
      _pad: function(n) {
        return n < 10 ? '0' + n.toString(10) : n.toString(10);
      },
      /**
       * A wrapper around `console.log`.
       */
      _log: function() {
        if (this.log) {
          console.log.apply(console, arguments);
        }
      },
      /**
       * A wrapper around `console.group`.
       */
      _group: function() {
        if (this.log) {
          console.group.apply(console, arguments);
        }
      },
      /**
       * A wrapper around `console.groupEnd`.
       */
      _groupEnd: function() {
        if (this.log) {
          console.groupEnd.apply(console, arguments);
        }
      }
    });
  </script>
</dom-module>
