<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/app-storage/app-localstorage/app-localstorage-document.html">

<link rel="import" href="../../bower_components/chart-elements/chart-line.html">

<link rel="import" href="chart-widget-behavior.html">
<link rel="import" href="log-behavior.html">
<link rel="import" href="widget-style.html">

<dom-module id="comparison-chart-line-widget">
  <template>
    <style include="widget-style">
    </style>
    <div class="last-updated">
      <div>Last updated A on [[_getDatetime(lastMessage1.parsedPayload.timestamp)]]</div>
      <div>Last updated B on [[_getDatetime(lastMessage2.parsedPayload.timestamp)]]</div>
    </div>
    <chart-line id="chart_id" data="[[_chart]]" options="[[_chart_options]]"></chart-line>
    <app-localstorage-document key="{{id}}" data="{{_data}}" log$={{verbose}}></app-localstorage-document>
  </template>
  <script>
    Polymer({
      is: 'comparison-chart-line-widget',
      behaviors: [
        AppBehaviors.ChartWidgetBehavior,
        AppBehaviors.LogBehavior
      ],
      properties: {
        label1: {
          type: String,
          value: null
        },
        label2: {
          type: String,
          value: null
        },
        lastMessage1: {
          type: Object,
          value: null,
          notify: true,
          observer: '_processMessage1'
        },
        lastMessage2: {
          type: Object,
          value: null,
          notify: true,
          observer: '_processMessage2'
        },
        property1: {
          type: String,
          value: null
        },
        property2: {
          type: String,
          value: null
        },
        _data: {
          type: Object,
          value: function() {
            return {
              labels: [],
              value1: [],
              value2: []
            };
          },
          notify: true
        },
        _chart: {
          type: Object,
          value: function() {
            return {
              labels: [],
              datasets: [{
                label: null,
                fill: true,
                backgroundColor: "rgba(220,220,220,0.2)",
                borderColor: "rgba(220,220,220,1)",
                borderWidth: 1,
                data: []
              },
              {
                label: null,
                fill: true,
                backgroundColor: "rgba(151,187,205,0.2)",
                borderColor: "rgba(151,187,205,1)",
                borderWidth: 1,
                data: []
              }]
            };
          }
        },
        _chart_options: {
          type: Object,
          value: {
            responsive: true,
            legend: {
              display: true,
              position: 'bottom'
            }
          }
        }
      },
      attached: function() {
        // link properies and chart representation together
        this._chart.datasets[0].label = this.label1;
        this._chart.datasets[1].label = this.label2;
        this._chart.labels = this._data.labels;
        this._chart.datasets[0].data = this._data.value1;
        this._chart.datasets[1].data = this._data.value2;
      },
      /**
       * process lastMessage1 with a timestamp and a variable property value
       */
      _processMessage1: function(event) {
        if (event) {
          var json = event.parsedPayload;
          var label = this._formatTimestamp(json.timestamp);
          var index = this._extendXAxis(label);
          // assign new value
          this._data.value1[index] = json[this.property1];
          // update chart
          this.$.chart_id.updateChart();
          this._notifyArrayMutation();
        }
      },
      /**
       * process lastMessage2 with a timestamp and a variable property value
       */
      _processMessage2: function(event) {
        if (event) {
          var json = event.parsedPayload;
          var label = this._formatTimestamp(json.timestamp);
          var index = this._extendXAxis(label);
          // assign new value
          this._data.value2[index] = json[this.property2];
          // update chart
          this.$.chart_id.updateChart();
          this._notifyArrayMutation();
        }
      },
      /**
       * extend x-axis with label
       */
      _extendXAxis: function(label) {
        var index = this._data.labels.lastIndexOf(label);
        // add new label if label isn't assigned so far
        if (index === -1) {
          this._data.labels.push(label);
          // continue data values linear with latest known values
          this._data.value1.push(this._data.value1[this._data.value1.length - 1]);
          this._data.value2.push(this._data.value2[this._data.value2.length - 1]);
          // shrink arrays at the beginning if chart line limit is reached
          if (this._data.labels.length > this.chart_line_limit) {
            this._data.labels.shift();
            this._data.value1.shift();
            this._data.value2.shift();
          }
          index = this._data.labels.length - 1;
        }
        // return latest index of assigned label
        return index;
      }
    });
  </script>
</dom-module>
