<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/app-layout/app-grid/app-grid-style.html">
<link rel="import" href="../../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../../bower_components/app-storage/app-localstorage/app-localstorage-document.html">

<link rel="import" href="../../bower_components/iron-icons/image-icons.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">

<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-styles/color.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">
<link rel="import" href="../../bower_components/paper-toggle-button/paper-toggle-button.html">

<link rel="import" href="../../bower_components/neon-animation/neon-animations.html">

<link rel="import" href="../../bower_components/chart-elements/chart-line.html">
<link rel="import" href="../../bower_components/mqtt-elements/mqtt-elements.html">

<link rel="import" href="widget-box.html">

<dom-module id="weather-station">
  <template>
    <style is="custom-style" include="app-grid-style">
      :host {
        display: block;
        @apply(--paper-font-common-base);
        --app-grid-gutter: 5px;
        --app-grid-expandible-item-columns: 3;
        --app-grid-item-height: 100%;
        --app-grid-columns: 2;
      }
      app-header {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 30vh;
        color: #fff;
        background-image: url(../img/header.png);
        background-position: bottom center;
        background-size: cover;
        z-index: 1; /* added z-index to avoid that the chart.js canvas shine through the header */
        --app-header-background-front-layer: {
          background: -webkit-linear-gradient(top, transparent 0%, transparent 50%, rgba(0,0,0,0.5) 100%);
        };
        --app-header-background-rear-layer: {
          background-color: var(--paper-blue-500);
        };
      }
      paper-icon-button {
        --paper-icon-button-ink-color: white;
      }
      [main-title] {
        font-size: 1.5em;
        font-weight: bold;
        text-align: center;
      }
      [condensed-title] {
        font-size: 1em;
        font-weight: normal;
        text-align: center;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      @media screen and (min-width: 1200px) {
        :host {
          --app-grid-columns: 3;
        },
        [main-title] {
          font-size: 3em;
        }
      }
      @media screen and (max-width: 700px) {
        :host {
          --app-grid-columns: 1;
        },
        [main-title] {
          font-size: 1em;
        }
      }
      .content-area {
        background-color: white;
      }
      .chart {
        width: 100%;
        height: 100%;
      }
      footer {
        height: 50px;
        line-height: 50px;
        text-align: center;
        background-color: white;
        font-size: 1em;
      }
      paper-dialog {
        width: 100%;
      }
      .widget-label {
        margin: 0px 2px 0px 2px;
        padding: 5px 15px 5px 15px;
        border-radius: 15px;
        background-color: var(--paper-red-500);
        color: white;
        font-size: 1em;
        white-space: nowrap;
      }
      .widget-label-font-small {
        font-size: 0.5em;
      }
      .widget-iron-icon {
        --iron-icon-height: 10vh;
        --iron-icon-width: 10vw;
      }
    </style>
    <!-- application -->
    <app-header-layout fullbleed>
      <!-- header -->
      <app-header condenses fixed
          effects="waterfall resize-snapped-title fade-background"
          effects-config='{"resize-snapped-title": {"startsAt": 0.8, "duration": "100ms"}, "fade-background": {"startsAt": 0.8, "endsAt": 0.9}}'>
        <app-toolbar sticky>
          <div main-title>My Weather Station</div>
          <div condensed-title>My Weather Station</div>
          <paper-icon-button icon="icons:more-vert" alt="Settings" on-tap="_openMQTTSettings"></paper-icon-button>
        </app-toolbar>
      </app-header>
      <!-- content area -->
      <div class="content-area">
        <div class="app-grid">

          <!-- TODO add tabindex; add last update info -->
          <widget-box id="temperature_widget_id" title="Temperature">
            <div class="widget-label">
              <span class="widget-label-font-small">DHT22</span>
              [[last_DHT22_response.parsedPayload.celsius]]°C
            </div>
            <div class="widget-label">
              <span class="widget-label-font-small">BMP280</span>
              [[last_BMP280_response.parsedPayload.celsius]]°C
            </div>
            <chart-line id="temperature_chart_id" class="chart" data="[[temperature_chart]]" options="[[options]]"></chart-line>
          </widget-box>
          <widget-box id="humidity_widget_id" title="Humidity">
            <div class="widget-label">[[last_DHT22_response.parsedPayload.humidity]]%</div>
            <chart-line id="humidity_chart_id" class="chart" data="[[humidity_chart]]" options="[[options]]"></chart-line>
          </widget-box>
          <widget-box id="pressure_widget_id" title="Atmospheric pressure">
            <div class="widget-label">[[last_BMP280_response.parsedPayload.pascal]]Pa</div>
            <chart-line id="pressure_chart_id" class="chart" data="[[pressure_chart]]" options="[[options]]"></chart-line>
          </widget-box>
          <widget-box id="co2_widget_id" title="CO2 in Air" label="[[last_MQ135_response.parsedPayload.co2]]%">
            <div class="widget-label">[[last_MQ135_response.parsedPayload.co2]]%</div>
            <chart-line id="co2_chart_id" class="chart" data="[[co2_chart]]" options="[[options]]"></chart-line>
          </widget-box>
          <!-- TODO remove dummy code from subsequent widgets -->
          <widget-box id="altitude_widget_id" title="Altitude">
            <div class="widget-label">
              <iron-icon icon="image:landscape"></iron-icon>
              [[last_BMP280_response.parsedPayload.altitude]]m
            </div>
            <iron-icon class="widget-iron-icon" icon="image:landscape"></iron-icon>
            <span>[[last_BMP280_response.parsedPayload.altitude]]m</span>
          </widget-box>
        </div>
      </div>
      <footer>
        &copy; Build with Polymer
      </footer>
    </app-header-layout>
    <!-- settings dialog -->
    <paper-dialog id="mqtt_dialog" entry-animation="scale-up-animation" exit-animation="fade-out-animation" withBackdrop>
      <h2>MQTT settings</h2>
      <paper-input label="Enter MQTT broker URL" value="{{mqtt_broker_url}}"></paper-input>
      <app-localstorage-document key="mqtt_broker_url" data="{{mqtt_broker_url}}" log></app-localstorage-document>
      <paper-input label="User" value="{{mqtt_broker_user}}"></paper-input>
      <app-localstorage-document key="mqtt_broker_user" data="{{mqtt_broker_user}}" log></app-localstorage-document>
      <!-- TODO Think about an alternative approach to keep password secure -->
      <paper-input label="Password" value="{{mqtt_broker_password}}"></paper-input>
      <app-localstorage-document key="mqtt_broker_password" data="{{mqtt_broker_password}}" log></app-localstorage-document>
      <paper-toggle-button id="toggle_id" checked="[[mqtt_connected]]" on-change="_connectMQTTBroker">[[_isConnected(mqtt_connected)]]</paper-toggle-button>
    </paper-dialog>
    <!-- MQTT connection & subscription -->
    <mqtt-connection
      id="mqtt_broker_id"
      url="{{mqtt_broker_url}}"
      username="{{mqtt_broker_user}}"
      password="{{mqtt_broker_password}}"
      with-credentials
      connected="{{mqtt_connected}}">
      <mqtt-subscription
        id="dht22_subscription"
        topic="sensor/DHT22"
        number-of-messages="Infinity"
        payload-type="Custom"
        payload-parse-function="[[_payloadParseFunc]]"
        last-message="{{last_DHT22_response}}">
      </mqtt-subscription>
      <mqtt-subscription
        topic="sensor/BMP280"
        number-of-messages="Infinity"
        payload-type="Custom"
        payload-parse-function="[[_payloadParseFunc]]"
        last-message="{{last_BMP280_response}}">
      </mqtt-subscription>
      <mqtt-subscription
        topic="sensor/MQ135"
        number-of-messages="Infinity"
        payload-type="Custom"
        payload-parse-function="[[_payloadParseFunc]]"
        last-message="{{last_MQ135_response}}">
      </mqtt-subscription>
    </mqtt-connection>
  </template>
  <script>
    Polymer({
      is: 'weather-station',
      properties: {
        _payloadParseFunc: {
          type: Function,
          readOnly: true,
          value: function () {
            return function() {
              var jsonString = String.fromCharCode.apply(null, new Uint8Array(arguments));
              return JSON.parse(jsonString);
            }
          }
        },
        mqtt_broker_url: {
          type: String,
          value: "wss://"
        },
        mqtt_broker_user: {
          type: String,
          value: null
        },
        mqtt_broker_password: {
          type: String,
          value: null
        },
        mqtt_connected: {
          type: Boolean,
          value: false,
          notify: true
        },
        last_DHT22_response: {
          type: Object,
          value: null,
          notify: true,
          observer: '_updateDHT22ChartValues'
        },
        last_BMP280_response: {
          type: Object,
          value: null,
          observer: '_updateBMP280ChartValues'
        },
        last_MQ135_response: {
          type: Object,
          value: null,
          observer: '_updateMQ135ChartValues'
        },
        temperature_chart: {
          type: Object,
          value: {
            labels: [],
            datasets: [{
              label: "Temperature DHT22",
              fill: true,
              backgroundColor: "rgba(220,220,220,0.2)",
              borderColor: "rgba(220,220,220,1)",
              borderWidth: 1,
              data: []
            },
            {
              label: "Temperature BMP280",
              fill: true,
              backgroundColor: "rgba(151,187,205,0.2)",
              borderColor: "rgba(151,187,205,1)",
              borderWidth: 1,
              data: []
            }]
          }
        },
        humidity_chart: {
          type: Object,
          value: {
            labels: [],
            datasets: [{
              label: "Humidity",
              fill: true,
              backgroundColor: "rgba(220,220,220,0.2)",
              borderColor: "rgba(220,220,220,1)",
              borderWidth: 1,
              data: []
            }]
          }
        },
        pressure_chart: {
          type: Object,
          value: {
            labels: [],
            datasets: [{
              label: "Atmospheric pressure",
              fill: true,
              backgroundColor: "rgba(220,220,220,0.2)",
              borderColor: "rgba(220,220,220,1)",
              borderWidth: 1,
              data: []
            }]
          }
        },
        co2_chart: {
          type: Object,
          value: {
            labels: [],
            datasets: [{
              label: "CO2 in Air",
              fill: true,
              backgroundColor: "rgba(220,220,220,0.2)",
              borderColor: "rgba(220,220,220,1)",
              borderWidth: 1,
              data: []
            }]
          }
        },
        options: {
          type: Object,
          value: {
            responsive: true,
            legend: {
              display: true,
              position: 'bottom'
            }
          }
        },
        max: {
          type: Number,
          value: 10
        }
      },
      attached: function() {
        this._updateGridStyles = this._updateGridStyles || function() {
          this.updateStyles();
          }.bind(this);
        window.addEventListener('resize', this._updateGridStyles);
      },
      ready: function() {
        // wait until app-storgage is able to load persisted preferences
        this.async(function() {
          // try to connect with MQTT broker
          this._connectMQTTBroker();
          // show mqtt settings if automatic connect wasn't possible
          if (!this.mqtt_connected) {
            console.log(this.mqtt_connected);
            // TODO
            //this._openMQTTSettings();
          }
        }.bind(this), 500);
      },
      detached: function() {
        window.removeEventListener('resize', this._updateGridStyles);
      },
      _openMQTTSettings: function() {
        this.$.mqtt_dialog.open();
      },
      _connectMQTTBroker: function(event) {

        console.log(event);

        console.log("Trying to connect to MQTT broker ...");
        if (this.mqtt_broker_url && this.mqtt_broker_user && this.mqtt_broker_password) {
          this.$.mqtt_broker_id.connect();
        }
      },
      _isConnected: function(connected) {
        return connected === true ? "on" : "off";
      },
      _updateDHT22ChartValues: function(event) {
        if (event) {
          console.log(event);
          var json = event.parsedPayload;
          // update temperature chart
          this._lengthenXAxis(this.temperature_chart, this._getCurrentTime());
          this.temperature_chart.datasets[0].data[this.temperature_chart.datasets[0].data.length - 1] = json.celsius;
          this.$.temperature_chart_id.updateChart();
          // update humidity chart
          this._lengthenXAxis(this.humidity_chart, this._getCurrentTime());
          this.humidity_chart.datasets[0].data[this.humidity_chart.datasets[0].data.length - 1] = json.humidity;
          this.$.humidity_chart_id.updateChart();
        }
      },
      _updateBMP280ChartValues: function(event) {
        if (event) {
          console.log(event);
          var json = event.parsedPayload;
          // update temperature chart
          this._lengthenXAxis(this.temperature_chart, this._getCurrentTime());
          this.temperature_chart.datasets[1].data[this.temperature_chart.datasets[1].data.length - 1] = json.celsius;
          this.$.temperature_chart_id.updateChart();
          // update pressure chart
          this._lengthenXAxis(this.pressure_chart, this._getCurrentTime());
          this.pressure_chart.datasets[0].data[this.pressure_chart.datasets[0].data.length - 1] = json.pascal;
          this.$.pressure_chart_id.updateChart();


          console.log(this.pressure_chart);
        }
      },
      _updateMQ135ChartValues: function(event) {
        if (event) {
          console.log(event);
          var json = event.parsedPayload;
          // update CO2 chart
          this._lengthenXAxis(this.co2_chart, this._getCurrentTime());
          this.co2_chart.datasets[0].data[this.temperature_chart.datasets[0].data.length - 1] = json.co2;
          this.$.co2_chart_id.updateChart();
        }
      },
      _lengthenXAxis(chart) {
        var now = this._getCurrentTime();
        var labels = chart.labels;
        var datasets = chart.datasets;
        // lengthen xAxis if 'now' doesn't exist already
        if (now !== labels[labels.length - 1]) {
          if (labels.length > this.max) {
            labels.shift();
          }
          labels.push(now);
          // for 'now' add 'NaN' as placeholder to all datasets
          for (var i = 0; i < datasets.length; i++) {
            if (datasets[i].length > this.max) {
              datasets[i].data.shift();
            }
            datasets[i].data.push('NaN');
          }
        }
      },
      _getCurrentTime: function() {
        var now = new Date();
        return [this._pad(now.getHours()), this._pad(now.getMinutes())].join(':');
      },
      _pad: function(n) {
        return n < 10 ? '0' + n.toString(10) : n.toString(10);
      }
    });
  </script>
</dom-module>
