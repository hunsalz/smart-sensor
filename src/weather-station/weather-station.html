<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/app-layout/app-grid/app-grid-style.html">
<link rel="import" href="../../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../../bower_components/app-storage/app-localstorage/app-localstorage-document.html">

<link rel="import" href="../../bower_components/iron-icons/image-icons.html">
<link rel="import" href="../../bower_components/iron-icons/maps-icons.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">

<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-styles/color.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">
<link rel="import" href="../../bower_components/paper-toggle-button/paper-toggle-button.html">

<link rel="import" href="../../bower_components/neon-animation/neon-animations.html">

<link rel="import" href="../../bower_components/platinum-sw/platinum-sw-elements.html">

<link rel="import" href="../../bower_components/mqtt-elements/mqtt-elements.html">

<link rel="import" href="../../bower_components/google-map/google-map.html">
<link rel="import" href="../../bower_components/google-map/google-map-marker.html">

<link rel="import" href="line-chart-item.html">
<link rel="import" href="line-chart.html">
<link rel="import" href="log-behavior.html">
<link rel="import" href="widget-layout.html">

<dom-module id="weather-station">
  <template strip-whitespace>
    <style is="custom-style" include="app-grid-style">
      :host {
        display: block;
        @apply(--paper-font-common-base);
        --app-grid-gutter: 5px;
        --app-grid-expandible-item-columns: 3;
        --app-grid-item-height: 100%;
        --app-grid-columns: 2;
      }
      app-header {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 30vh;
        color: white;
        background-image: url(../img/header2.png);
        background-position: bottom center;
        background-size: cover;
        z-index: 1; /* added z-index to avoid that the chart.js canvas shine through the header */
        --app-header-background-front-layer: {
          background: -webkit-linear-gradient(top, transparent 0%, transparent 50%, rgba(0,0,0,0.5) 100%);
        };
        --app-header-background-rear-layer: {
          background-color: var(--paper-blue-500);
        };
      }
      [main-title] {
        font-size: 1.5em;
        font-weight: bold;
      }
      [condensed-title] {
        font-size: 1em;
        font-weight: normal;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      @media screen and (orientation: landscape) {
        app-toolbar.tall {
          height: 10vh;
        }
      }
      @media screen and (orientation: portrait) {
        app-toolbar.tall {
          height: 30vh;
        }
      }
      @media screen and (min-width: 1200px) {
        :host {
          --app-grid-columns: 3;
        }
      }
      @media screen and (max-width: 700px) {
        :host {
          --app-grid-columns: 1;
        }
      }
      .content-area {
        background-color: white;
      }
      .content-footer {
        padding-top: 2vh;
        font-size: 1em;
        text-align: center;
        @apply(--layout-vertical);
        @apply(--layout-center);
      }
      comparison-line-chart {
        width: 100%;
        height: 100%;
      }
      line-chart {
        width: 100%;
        height: 100%;
      }
      google-map {
        width: 100%;
        height: 40vh;
      }
      paper-icon-button {
        --paper-icon-button-ink-color: white;
      }
      paper-dialog {
        width: 100%;
      }
      .widget-label {
        margin: 0px 2px 0px 2px;
        padding: 5px 15px 5px 15px;
        border-radius: 20px;
        background-color: var(--paper-red-500);
        color: white;
        font-size: 1em;
        font-weight: 500;
        line-height: 1.5em;
        white-space: nowrap;
        @apply(--layout-horizontal);
        @apply(--layout-center);
      }
      .widget-label-font-small {
        font-size: 0.5em;
      }
      .widget-iron-icon {
        --iron-icon-height: 10vh;
        --iron-icon-width: 10vw;
      }
    </style>
    <!-- application -->
    <app-header-layout fullbleed>
      <!-- header -->
      <app-header condenses fixed
          effects="waterfall resize-snapped-title fade-background"
          effects-config='{"resize-snapped-title": {"startsAt": 0.8, "duration": "100ms"}, "fade-background": {"startsAt": 0.8, "endsAt": 0.9}}'>
        <app-toolbar sticky>
          <div condensed-title>[[app_title]]</div>
          <paper-icon-button icon="{{_isCollapsed(collapsed)}}" on-tap="_toggleWidgets"></paper-icon-button>
          <paper-icon-button icon="icons:more-vert" on-tap="_openMQTTSettings"></paper-icon-button>
        </app-toolbar>
        <app-toolbar class="tall">
          <div spacer main-title>[[app_title]]</div>
        </app-toolbar>
      </app-header>

      <!-- content area -->
      <div class="content-area">

        <!-- dashboard -->
        <div class="app-grid">

          <widget-layout id="widget_temperature_id" title="Temperature" value-limit="12">
            <span class="widget-label">
              <span class="widget-label-font-small">DHT22</span>
              [[last_DHT22_message.parsedPayload.celsius]]°C
            </span>
            <span class="widget-label">
              <span class="widget-label-font-small">BMP280</span>
              [[last_BMP280_message.parsedPayload.celsius]]°C
            </span>
            <line-chart id="temperature" labels="{{labels_01}}" datasets="{{datasets_01}}">
              <line-chart-item
                labels="{{labels_01}}"
                dataset="{{datasets_01.0}}"
                options='{"label": "DHT22", "borderColor": "rgba(220,220,220,1)", "backgroundColor": "rgba(220,220,220,0.2)"}'
                last-message="[[_computeTemperatureDHT22(last_DHT22_message)]]">
              </line-chart-item>
              <line-chart-item
                labels="{{labels_01}}"
                dataset="{{datasets_01.1}}"
                options='{"label": "BMP280", "borderColor": "rgba(151,187,205,0.2)", "backgroundColor": "rgba(151,187,205,0.2)"}'
                last-message="[[_computeTemperatureBMP280(last_BMP280_message)]]">
              </line-chart-item>
            </line-chart>
          </widget-layout>

          <widget-layout id="widget_humidity_id" title="Humidity">
            <span class="widget-label">
              [[last_DHT22_message.parsedPayload.humidity]]%
            </span>
            <line-chart id="humidity" labels="{{labels_02}}" datasets="{{datasets_02}}">
              <line-chart-item
                labels="{{labels_02}}"
                dataset="{{datasets_02.0}}"
                options='{"label": "Humidity"}'
                last-message="[[_computeHumidity(last_DHT22_message)]]">
              </line-chart-item>
            </line-chart>
          </widget-layout>

          <widget-layout id="widget_pressure_id" title="Atmospheric pressure">
            <span class="widget-label">
              [[last_BMP280_message.parsedPayload.pascal]] Pa
            </span>
            <line-chart id="pressure" labels="{{labels_03}}" datasets="{{datasets_03}}">
              <line-chart-item
                labels="{{labels_03}}"
                dataset="{{datasets_03.0}}"
                options='{"label": "Pascal"}'
                last-message="[[_computePressure(last_BMP280_message)]]">
              </line-chart-item>
            </line-chart>
          </widget-layout>

          <widget-layout id="widget_co2_id" title="CO2 in Air">
            <span class="widget-label">
              [[last_MQ135_message.parsedPayload.ppm]] PPM
            </span>
            <line-chart id="co2" labels="{{labels_04}}" datasets="{{datasets_04}}">
              <line-chart-item
                labels="{{labels_04}}"
                dataset="{{datasets_04.0}}"
                options='{"label": "Default volume", "borderColor": "rgba(50,200,50,0.1)", "backgroundColor": "rgba(50,200,50,0.1)"}'
                last-message='{"value": 400, "timestamp": 1482420761}'>
              </line-chart-item>
              <line-chart-item
                labels="{{labels_04}}"
                dataset="{{datasets_04.1}}"
                options='{"label": "Parts per million (PPM)"}'
                last-message="[[_computeCO2(last_MQ135_message)]]">
              </line-chart-item>
            </line-chart>
          </widget-layout>

          <widget-layout id="widget_altitude_id" title="Altitude">
            <span class="widget-label">
              <iron-icon icon="image:landscape"></iron-icon>
              [[last_BMP280_message.parsedPayload.altitude]] m
            </span>
            <iron-icon class="widget-iron-icon" icon="image:landscape"></iron-icon>
            <span>[[last_BMP280_message.parsedPayload.altitude]]m</span>
          </widget-layout>

          <widget-layout id="widget_location_id" title="Location">
            <span class="widget-label">
              <iron-icon icon="maps:place"></iron-icon>
              <span>48.998648, 8.3919072</span>
            </span>
            <google-map
              latitude="[[location.latitude]]"
              longitude="[[location.longitude]]"
              api-key="[[google_map_api_key]]"
              fit-to-markers>
              <google-map-marker
                latitude="[[location.latitude]]"
                longitude="[[location.longitude]]"
                title="[[app_title]]">
              </google-map-marker>
            </google-map>
          </widget-layout>

          <!-- widgets for testing purposes only -->

          <!--
          <widget-layout id="widget_test1_id" title="Test 1">
            <span class="widget-label">
              <span class="widget-label-font-small">A</span>
              [[last_A_message.parsedPayload.celsius]]°C
            </span>
            <line-chart id="test1_id" labels="{{labels_test1}}" datasets="{{datasets_test1}}" value-limit="12">
              <line-chart-item
                labels="{{labels_test1}}"
                dataset="{{datasets_test1.0}}"
                options='{"label": "Celsius A"}'
                last-message="[[_computeTestA(last_A_message)]]">
              </line-chart-item>
            </line-chart>
          </widget-layout>

          <widget-layout id="widget_test2_id" title="Test 2">
            <span class="widget-label">
              <span class="widget-label-font-small">B</span>
              [[last_B_message.parsedPayload.celsius]]°C
            </span>
            <line-chart id="test2_id" labels="{{labels_test2}}" datasets="{{datasets_test2}}">
              <line-chart-item
                labels="{{labels_test2}}"
                dataset="{{datasets_test2.0}}"
                options='{"label": "Celsius B"}'
                last-message="[[_computeTestB(last_B_message)]]">
              </line-chart-item>
            </line-chart>
          </widget-layout>

          <widget-layout id="widget_test3_id" title="Test 3">
            <span class="widget-label">
              <span class="widget-label-font-small">A</span>
              [[last_A_message.parsedPayload.celsius]]°C
            </span>
            <span class="widget-label">
              <span class="widget-label-font-small">B</span>
              [[last_B_message.parsedPayload.celsius]]°C
            </span>
            <line-chart id="test3_id" labels="{{labels_test3}}" datasets="{{datasets_test3}}" value-limit="12">
              <line-chart-item
                labels="{{labels_test3}}"
                dataset="{{datasets_test3.0}}"
                options='{"label": "Default", "borderColor": "rgba(255,0,0,0.1)", "backgroundColor": "rgba(255,0,0,0.1)"}'
                last-message='{"value": 20.5, "timestamp": 1482420761}'>
              </line-chart-item>
              <line-chart-item
                labels="{{labels_test3}}"
                dataset="{{datasets_test3.1}}"
                options='{"label": "Celsius A", "borderColor": "rgba(220,220,220,1)", "backgroundColor": "rgba(220,220,220,0.2)"}'
                last-message="[[_computeTestA(last_A_message)]]">
              </line-chart-item>
              <line-chart-item
                labels="{{labels_test3}}"
                dataset="{{datasets_test3.2}}"
                options='{"label": "Celsius B", "borderColor": "rgba(151,187,205,0.2)", "backgroundColor": "rgba(151,187,205,0.2)"}'
                last-message="[[_computeTestB(last_B_message)]]">
              </line-chart-item>
            </line-chart>
          </widget-layout>
          -->

        </div>
      </div>
      <div class="content-footer">
        <p>&copy; Build with <a href="https://www.polymer-project.org">Polymer</a></p>
      </div>
    </app-header-layout>

    <!-- settings dialog -->
    <paper-dialog id="mqtt_dialog" entry-animation="scale-up-animation" exit-animation="fade-out-animation" withBackdrop>
      <h2>MQTT settings</h2>
      <paper-input label="Enter MQTT broker URL" value="{{mqtt_broker_url}}"></paper-input>
      <app-localstorage-document key="mqtt_broker_url" data="{{mqtt_broker_url}}"></app-localstorage-document>
      <paper-input label="User" value="{{mqtt_broker_user}}"></paper-input>
      <app-localstorage-document key="mqtt_broker_user" data="{{mqtt_broker_user}}"></app-localstorage-document>
      <!-- TODO think about an alternative approach to keep the password secure -->
      <paper-input label="Password" value="{{mqtt_broker_password}}"></paper-input>
      <app-localstorage-document key="mqtt_broker_password" data="{{mqtt_broker_password}}"></app-localstorage-document>
      <paper-toggle-button id="toggle_id" checked="[[mqtt_connected]]" on-change="_connectMQTTBroker">[[_isConnected(mqtt_connected)]]</paper-toggle-button>
    </paper-dialog>

    <!-- MQTT connection & subscription -->
    <mqtt-connection
      id="mqtt_broker_id"
      url="{{mqtt_broker_url}}"
      username="{{mqtt_broker_user}}"
      password="{{mqtt_broker_password}}"
      with-credentials
      connected="{{mqtt_connected}}">
      <mqtt-subscription
        id="dht22_subscription"
        topic="sensor/DHT22"
        number-of-messages="[[mqtt_max_number_of_messages]]"
        payload-type="Custom"
        payload-parse-function="[[_payloadParseFunc]]"
        last-message="{{last_DHT22_message}}">
      </mqtt-subscription>
      <mqtt-subscription
        topic="sensor/BMP280"
        number-of-messages="[[mqtt_max_number_of_messages]]"
        payload-type="Custom"
        payload-parse-function="[[_payloadParseFunc]]"
        last-message="{{last_BMP280_message}}">
      </mqtt-subscription>
      <mqtt-subscription
        topic="sensor/MQ135"
        number-of-messages="[[mqtt_max_number_of_messages]]"
        payload-type="Custom"
        payload-parse-function="[[_payloadParseFunc]]"
        last-message="{{last_MQ135_message}}">
      </mqtt-subscription>
      <mqtt-subscription
        topic="sensor/A"
        number-of-messages="[[mqtt_max_number_of_messages]]"
        payload-type="Custom"
        payload-parse-function="[[_payloadParseFunc]]"
        last-message="{{last_A_message}}">
      </mqtt-subscription>
      <mqtt-subscription
        topic="sensor/B"
        number-of-messages="[[mqtt_max_number_of_messages]]"
        payload-type="Custom"
        payload-parse-function="[[_payloadParseFunc]]"
        last-message="{{last_B_message}}">
      </mqtt-subscription>
    </mqtt-connection>

    <!-- service worker -->
    <platinum-sw-register skip-waiting
                          clients-claim
                          auto-register
                          reload-on-install>
      <platinum-sw-cache default-cache-strategy="fastest"></platinum-sw-cache>
    </platinum-sw-register>

  </template>
  <script>
    Polymer({
      is: 'weather-station',
      behaviors: [
        AppBehaviors.LogBehavior
      ],
      properties: {
        _payloadParseFunc: {
          type: Function,
          readOnly: true,
          value: function() {
            return function() {
              var jsonString = String.fromCharCode.apply(null, new Uint8Array(arguments));
              return JSON.parse(jsonString);
            }
          }
        },
        app_title: {
          type: String,
          value: 'My Weather Station'
        },
        mqtt_broker_url: {
          type: String,
          value: "wss://m21.cloudmqtt.com:33444" // TODO change to your own
        },
        mqtt_broker_user: {
          type: String,
          value: "dashboard" // TODO change to your own
        },
        mqtt_broker_password: {
          type: String,
          value: "password" // TODO change to your own
        },
        mqtt_connected: {
          type: Boolean,
          value: false,
          notify: true
        },
        mqtt_max_number_of_messages: {
          type: Number,
          value: 10
        },
        google_map_api_key: {
          type: String,
          value: 'AIzaSyA2QZSQj4nimOBBNG7ZNfY6MKD3lW8-OiI' // API key is restricted to specific URL; TODO change to your own
        },
        location: {
          type: Object,
          value: {
            latitude: '48.998648',
            longitude: '8.377365'
          }
        },
        collapsed: {
          type: Boolean,
          value: true,
          notify: true
        }
      },
      listeners: {
        'toggle': '_applyToggleState'
      },
      attached: function() {
        // listen to window resizing events
        this._updateGridStyles = this._updateGridStyles || function() {
            this.updateStyles();
          }.bind(this);
        window.addEventListener('resize', this._updateGridStyles);
        // try to connect automatically with MQTT broker
        this.async(function() {
          this._connectMQTTBroker();
        });
        // apply icon toogle state initially
        this._applyToggleState();
      },
      detached: function() {
        window.removeEventListener('resize', this._updateGridStyles);
      },
      _computeTemperatureDHT22: function(event) {
        if (event) {
          return {value: event.parsedPayload.celsius, timestamp: event.parsedPayload.timestamp};
        }
        return {value: null, timestamp: null};
      },
      _computeTemperatureBMP280: function(event) {
        if (event) {
          return {value: event.parsedPayload.celsius, timestamp: event.parsedPayload.timestamp};
        }
        return {value: null, timestamp: null};
      },
      _computeHumidity: function(event) {
        if (event) {
          return {value: event.parsedPayload.humidity, timestamp: event.parsedPayload.timestamp};
        }
        return {value: null, timestamp: null};
      },
      _computePressure: function(event) {
        if (event) {
          return {value: event.parsedPayload.pascal, timestamp: event.parsedPayload.timestamp};
        }
        return {value: null, timestamp: null};
      },
      _computeCO2: function(event) {
        if (event) {
          return {value: event.parsedPayload.pmm, timestamp: event.parsedPayload.timestamp};
        }
        return {value: null, timestamp: null};
      },
      _computeTestA: function(event) {
        if (event) {
          return {value: event.parsedPayload.celsius, timestamp: event.parsedPayload.timestamp};
        }
        return {value: 22.3, timestamp: 1482420761};
      },
      _computeTestB: function(event) {
        if (event) {
          return {value: event.parsedPayload.celsius, timestamp: event.parsedPayload.timestamp};
        }
        return {value: 23.1, timestamp: 1482420761};
      },
      _isCollapsed: function(collapsed) {
        return collapsed ? 'icons:expand-more' : 'icons:expand-less';
      },
      _applyToggleState: function() {
        // compute toggle state of all <widget-layout> elements
        var nodes = this.querySelectorAll('widget-layout');
        var state = 0;
        for (var i = 0; i < nodes.length; i++) {
          state += nodes[i].isCollapsed();
        }
        // switch toggle according to state result
        this.collapsed = state === 0 ? false : true;
      },
      _toggleWidgets: function() {
        // toggle all <widget-layout> elements
        this.collapsed = !this.collapsed;
        var nodes = this.querySelectorAll("widget-layout");
        for (var i = 0; i < nodes.length; i++) {
          nodes[i].collapse(this.collapsed);
        }
      },
      _openMQTTSettings: function() {
        this.$.mqtt_dialog.open();
      },
      _connectMQTTBroker: function() {
        this._log("MQTT connection: ", "Trying to connect to [" + this.mqtt_broker_url + "] ...");
        if (this.mqtt_broker_url && this.mqtt_broker_user && this.mqtt_broker_password) {
          this.$.mqtt_broker_id.connect();
        }
      },
      _isConnected: function(connected) {
        return connected === true ? 'on' : 'off';
      }
    });
  </script>
</dom-module>
