<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/app-layout/app-grid/app-grid-style.html">
<link rel="import" href="../../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../../bower_components/app-storage/app-localstorage/app-localstorage-document.html">

<link rel="import" href="../../bower_components/iron-icons/image-icons.html">
<link rel="import" href="../../bower_components/iron-icons/maps-icons.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">

<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-styles/color.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">
<link rel="import" href="../../bower_components/paper-toggle-button/paper-toggle-button.html">

<link rel="import" href="../../bower_components/neon-animation/neon-animations.html">

<link rel="import" href="../../bower_components/chart-elements/chart-line.html">
<link rel="import" href="../../bower_components/mqtt-elements/mqtt-elements.html">

<link rel="import" href="../../bower_components/google-map/google-map.html">
<link rel="import" href="../../bower_components/google-map/google-map-marker.html">

<link rel="import" href="widget-box.html">

<dom-module id="weather-station">
  <template>
    <style is="custom-style" include="app-grid-style">
      :host {
        display: block;
        @apply(--paper-font-common-base);
        --app-grid-gutter: 5px;
        --app-grid-expandible-item-columns: 3;
        --app-grid-item-height: 100%;
        --app-grid-columns: 2;
      }
      app-header {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 30vh;
        color: #fff;
        background-image: url(../img/header.png);
        background-position: bottom center;
        background-size: cover;
        z-index: 1; /* added z-index to avoid that the chart.js canvas shine through the header */
        --app-header-background-front-layer: {
          background: -webkit-linear-gradient(top, transparent 0%, transparent 50%, rgba(0,0,0,0.5) 100%);
        };
        --app-header-background-rear-layer: {
          background-color: var(--paper-blue-500);
        };
      }
      [main-title] {
        font-size: 1.5em;
        font-weight: bold;
      }
      [condensed-title] {
        font-size: 1em;
        font-weight: normal;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      @media screen and (orientation: landscape) {
        app-toolbar.tall {
          height: 10vh;
        }
      }
      @media screen and (orientation: portrait) {
        app-toolbar.tall {
          height: 30vh;
        }
      }
      @media screen and (min-width: 1200px) {
        :host {
          --app-grid-columns: 3;
        }
      }
      @media screen and (max-width: 700px) {
        :host {
          --app-grid-columns: 1;
        }
      }
      .content-area {
        background-color: white;
      }
      .content-footer {
        padding-top: 2vh;
        font-size: 1em;
        text-align: center;
        @apply(--layout-vertical);
        @apply(--layout-center);
      }
      chart-line {
        width: 100%;
        height: 100%;
      }
      google-map {
        width: 100%;
        height: 40vh;
      }
      paper-icon-button {
        --paper-icon-button-ink-color: white;
      }
      paper-dialog {
        width: 100%;
      }
      .widget-label {
        margin: 0px 2px 0px 2px;
        padding: 5px 15px 5px 15px;
        border-radius: 15px;
        background-color: var(--paper-red-500);
        color: white;
        font-size: 1em;
        white-space: nowrap;
      }
      .widget-label-font-small {
        font-size: 0.5em;
      }
      .widget-iron-icon {
        --iron-icon-height: 10vh;
        --iron-icon-width: 10vw;
      }
      .widget-datetime {
        font-size: 0.75em;
        font-weight: bold;
        color: grey;
        text-align: center;
        padding-top: 10px;
        padding-bottom: 10px;
      }
    </style>
    <!-- application -->
    <app-header-layout fullbleed>
      <!-- header -->
      <app-header condenses fixed
          effects="waterfall resize-snapped-title fade-background"
          effects-config='{"resize-snapped-title": {"startsAt": 0.8, "duration": "100ms"}, "fade-background": {"startsAt": 0.8, "endsAt": 0.9}}'>
        <app-toolbar sticky>
          <div condensed-title>[[app_title]]</div>
          <paper-icon-button icon="icons:more-vert" alt="Settings" on-tap="_openMQTTSettings"></paper-icon-button>
        </app-toolbar>
        <app-toolbar class="tall">
          <div spacer main-title>[[app_title]]</div>
        </app-toolbar>
      </app-header>
      <!-- content area -->
      <div class="content-area">
        <div class="app-grid">
          <widget-box title="Temperature">
            <div class="widget-label">
              <span class="widget-label-font-small">DHT22</span>
              [[_getLastItem(temperature_values.DHT22_celsius.*)]]째C
            </div>
            <div class="widget-label">
              <span class="widget-label-font-small">BMP280</span>
              [[_getLastItem(temperature_values.BMP280_celsius.*)]]째C
            </div>
            <div class="widget-datetime">Last updated on [[temperature_values.last_updated]]</div>
            <chart-line id="temperature_chart_id" class="chart" data="[[temperature_chart]]" options="[[chart_options]]"></chart-line>
          </widget-box>
          <widget-box title="Humidity">
            <div class="widget-label">[[_getLastItem(humidity_values.humidity.*)]]%</div>
            <div class="widget-datetime">Last updated on [[humidity_values.last_updated]]</div>
            <chart-line id="humidity_chart_id" data="[[humidity_chart]]" options="[[chart_options]]"></chart-line>
          </widget-box>
          <widget-box title="Atmospheric pressure">
            <div class="widget-label">[[_getLastItem(pressure_values.pascal.*)]]Pa</div>
            <div class="widget-datetime">Last updated on [[pressure_values.last_updated]]</div>
            <chart-line id="pressure_chart_id" data="[[pressure_chart]]" options="[[chart_options]]"></chart-line>
          </widget-box>
          <widget-box title="CO2 in Air">
            <div class="widget-label">[[_getLastItem(co2_values.co2.*)]]%</div>
            <div class="widget-datetime">Last updated on [[co2_values.last_updated]]</div>
            <chart-line id="co2_chart_id" data="[[co2_chart]]" options="[[chart_options]]"></chart-line>
          </widget-box>
          <widget-box title="Altitude">
            <div class="widget-label">
              <iron-icon icon="image:landscape"></iron-icon>
              [[_getLastItem(altitude_values.altitude.*)]]m
            </div>
            <iron-icon class="widget-iron-icon" icon="image:landscape"></iron-icon>
            <span>[[_getLastItem(altitude_values.altitude.*)]]m</span>
          </widget-box>
          <widget-box title="Location">
            <div class="widget-label">
              <iron-icon icon="maps:place"></iron-icon>
              <span>48.998648, 8.3919072</span>
            </div>
            <google-map latitude="[[location.latitude]]" longitude="[[location.longitude]]" api-key="[[google_map_api_key]]" fit-to-markers>
              <google-map-marker latitude="[[location.latitude]]" longitude="[[location.longitude]]" title="[[app_title]]"></google-map-marker>
            </google-map>
          </widget-box>
          <widget-box title="Test data">
            <div class="widget-label">
              <span class="widget-label-font-small">A</span>
              [[_getLastItem(test_values.celsiusA.*)]]째C
            </div>
            <div class="widget-label">
              <span class="widget-label-font-small">B</span>
              [[_getLastItem(test_values.celsiusB.*)]]째C
            </div>
            <div class="widget-datetime">Last updated on [[test_values.last_updated]]</div>
            <chart-line id="test_chart_id" data="{{test_chart}}" options="[[chart_options]]"></chart-line>
          </widget-box>
        </div>
      </div>
      <div class="content-footer">&copy; Build with Polymer</div>
    </app-header-layout>
    <!-- settings dialog -->
    <paper-dialog id="mqtt_dialog" entry-animation="scale-up-animation" exit-animation="fade-out-animation" withBackdrop>
      <h2>MQTT settings</h2>
      <paper-input label="Enter MQTT broker URL" value="{{mqtt_broker_url}}"></paper-input>
      <app-localstorage-document key="mqtt_broker_url" data="{{mqtt_broker_url}}"></app-localstorage-document>
      <paper-input label="User" value="{{mqtt_broker_user}}"></paper-input>
      <app-localstorage-document key="mqtt_broker_user" data="{{mqtt_broker_user}}"></app-localstorage-document>
      <!-- TODO think about an alternative approach to keep the password secure -->
      <paper-input label="Password" value="{{mqtt_broker_password}}"></paper-input>
      <app-localstorage-document key="mqtt_broker_password" data="{{mqtt_broker_password}}"></app-localstorage-document>
      <paper-toggle-button id="toggle_id" checked="[[mqtt_connected]]" on-change="_connectMQTTBroker">[[_isConnected(mqtt_connected)]]</paper-toggle-button>
    </paper-dialog>
    <!-- MQTT connection & subscription -->
    <mqtt-connection
      id="mqtt_broker_id"
      url="{{mqtt_broker_url}}"
      username="{{mqtt_broker_user}}"
      password="{{mqtt_broker_password}}"
      with-credentials
      connected="{{mqtt_connected}}">
      <mqtt-subscription
        id="dht22_subscription"
        topic="sensor/DHT22"
        number-of-messages="[[mqtt_max_number_of_messages]]"
        payload-type="Custom"
        payload-parse-function="[[_payloadParseFunc]]"
        on-mqtt-subscription-message="_updateDHT22Values">
      </mqtt-subscription>
      <mqtt-subscription
        topic="sensor/BMP280"
        number-of-messages="[[mqtt_max_number_of_messages]]"
        payload-type="Custom"
        payload-parse-function="[[_payloadParseFunc]]"
        on-mqtt-subscription-message="_updateBMP280Values">
      </mqtt-subscription>
      <mqtt-subscription
        topic="sensor/MQ135"
        number-of-messages="[[mqtt_max_number_of_messages]]"
        payload-type="Custom"
        payload-parse-function="[[_payloadParseFunc]]"
        on-mqtt-subscription-message="_updateMQ135Values">
      </mqtt-subscription>
      <mqtt-subscription
        topic="sensor/data"
        number-of-messages="[[mqtt_max_number_of_messages]]"
        payload-type="Custom"
        payload-parse-function="[[_payloadParseFunc]]"
        on-mqtt-subscription-message="_updateTestValues">
      </mqtt-subscription>
    </mqtt-connection>
    <app-localstorage-document key="temperature_values" data="{{temperature_values}}" log></app-localstorage-document>
    <app-localstorage-document key="humidity_values" data="{{humidity_values}}" log></app-localstorage-document>
    <app-localstorage-document key="pressure_values" data="{{pressure_values}}" log></app-localstorage-document>
    <app-localstorage-document key="altitude_values" data="{{altitude_values}}" log></app-localstorage-document>
    <app-localstorage-document key="co2_values" data="{{co2_values}}" log></app-localstorage-document>
    <app-localstorage-document key="test_values" data="{{test_values}}" log></app-localstorage-document>
  </template>
  <script>
    Polymer({
      is: 'weather-station',
      properties: {
        _payloadParseFunc: {
          type: Function,
          readOnly: true,
          value: function () {
            return function() {
              var jsonString = String.fromCharCode.apply(null, new Uint8Array(arguments));
              return JSON.parse(jsonString);
            }
          }
        },
        app_title: {
          type: String,
          value: 'My Weather Station'
        },
        mqtt_broker_url: {
          type: String,
          value: "wss://"
        },
        mqtt_broker_user: {
          type: String,
          value: null
        },
        mqtt_broker_password: {
          type: String,
          value: null
        },
        mqtt_connected: {
          type: Boolean,
          value: false,
          notify: true
        },
        mqtt_max_number_of_messages: {
          type: Number,
          value: 10
        },
        temperature_values: {
          type: Object,
          value: {
            last_updated: null,
            labels: [],
            DHT22_celsius: [],
            BMP280_celsius: []
          },
          notify: true
        },
        humidity_values: {
          type: Object,
          value: {
            last_updated: null,
            labels: [],
            humidity: []
          },
          notify: true
        },
        pressure_values: {
          type: Object,
          value: {
            last_updated: null,
            labels: [],
            pascal: []
          },
          notify: true
        },
        altitude_values: {
          type: Object,
          value: {
            last_updated: null,
            labels: [],
            altitude: []
          },
          notify: true
        },
        co2_values: {
          type: Object,
          value: {
            last_updated: null,
            labels: [],
            co2: []
          },
          notify: true
        },
        test_values: {
          type: Object,
          value: {
            last_updated: null,
            labels: [],
            celsiusA: [],
            celsiusB: [],
          },
          notify: true
        },
        temperature_chart: {
          type: Object,
          value: {
            labels: [''],
            datasets: [{
              label: "Temperature DHT22",
              fill: true,
              backgroundColor: "rgba(220,220,220,0.2)",
              borderColor: "rgba(220,220,220,1)",
              borderWidth: 1,
              data: ['NaN']
            },
            {
              label: "Temperature BMP280",
              fill: true,
              backgroundColor: "rgba(151,187,205,0.2)",
              borderColor: "rgba(151,187,205,1)",
              borderWidth: 1,
              data: ['NaN']
            }]
          }
        },
        humidity_chart: {
          type: Object,
          value: {
            labels: [''],
            datasets: [{
              label: "Humidity",
              fill: true,
              backgroundColor: "rgba(220,220,220,0.2)",
              borderColor: "rgba(220,220,220,1)",
              borderWidth: 1,
              data: ['NaN']
            }]
          }
        },
        pressure_chart: {
          type: Object,
          value: {
            labels: [''],
            datasets: [{
              label: "Atmospheric pressure",
              fill: true,
              backgroundColor: "rgba(220,220,220,0.2)",
              borderColor: "rgba(220,220,220,1)",
              borderWidth: 1,
              data: ['NaN']
            }]
          }
        },
        co2_chart: {
          type: Object,
          value: {
            labels: [''],
            datasets: [{
              label: "CO2 in Air",
              fill: true,
              backgroundColor: "rgba(220,220,220,0.2)",
              borderColor: "rgba(220,220,220,1)",
              borderWidth: 1,
              data: ['NaN']
            }]
          }
        },
        test_chart: {
          type: Object,
          value: {
            labels: [''],
            datasets: [{
              label: "celsiusA",
              fill: true,
              backgroundColor: "rgba(220,220,220,0.2)",
              borderColor: "rgba(220,220,220,1)",
              borderWidth: 1,
              data: ['NaN']
            },
            {
              label: "celsiusB",
              fill: true,
              backgroundColor: "rgba(151,187,205,0.2)",
              borderColor: "rgba(151,187,205,1)",
              borderWidth: 1,
              data: ['NaN']
            }]
          }
        },
        chart_options: {
          type: Object,
          value: {
            responsive: true,
            legend: {
              display: true,
              position: 'bottom'
            }
          }
        },
        max_chart_view: {
          type: Number,
          value: 5
        },
        google_map_api_key: {
          type: String,
          value: 'AIzaSyA2QZSQj4nimOBBNG7ZNfY6MKD3lW8-OiI' // API key is restricted to specific URL; TODO change to your own
        },
        location: {
          type: Object,
          value: {
            latitude: '48.998648',
            longitude: '8.377365'
          }
        },
        /**
         * when true perform detail logging
         */
        log: {
          type: Boolean,
          value: true
        }
      },
      attached: function() {
        this._updateGridStyles = this._updateGridStyles || function() {
          this.updateStyles();
          }.bind(this);
        window.addEventListener('resize', this._updateGridStyles);
        // try to connect automatically with MQTT broker
        this.async(function() {
          this._connectMQTTBroker();
        });
      },
      detached: function() {
        window.removeEventListener('resize', this._updateGridStyles);
      },
      _openMQTTSettings: function() {
        this.$.mqtt_dialog.open();
      },
      _connectMQTTBroker: function() {
        console.log("Trying to connect to [" + this.mqtt_broker_url + "] ...");
        if (this.mqtt_broker_url && this.mqtt_broker_user && this.mqtt_broker_password) {
          this.$.mqtt_broker_id.connect();
        }
      },
      _isConnected: function(connected) {
        return connected === true ? "on" : "off";
      },

      _abc: function(value_path) {

        var values = this.get(value_path);

        var label = this._formatTimestamp(json.timestamp);
        // sort and put message into right data structure
        if (values.labels[values.length - 1] === label) {
          this._log("Skipping value for an existing label.", json);
        } else {
          this._log("Adding new value.", json);
          if (this.values.labels.length > this.max_chart_view) {
            // no need to notify 'shift'-operation explicit; 'push'-opertion follows shortly afterwards
            this.values.labels.shift();
            this.values.DHT22_celsius.shift();
          }
          this.push(value_path + '.labels', label);
          this.push(value_path + '.DHT22_celsius', json.celsius);
        }

      },

      _updateDHT22Values: function(event) {
        if (event) {
          var json = event.detail.parsedPayload;

          this.set('temperature_values.last_updated', new Date(json.timestamp * 1000));
          this.set('humidity_values.last_updated', new Date(json.timestamp * 1000));



          var label = this._formatTimestamp(json.timestamp);


          // sort and put message into right data structure
          if (this.temperature_values.labels[this.temperature_values.labels.length - 1] === label) {
            this._log("Skipping value for an existing label.", json);
          } else {
            this._log("Adding new value.", json);
            if (this.temperature_values.labels.length > this.max_chart_view) {
              // no need to notify 'shift'-operation explicit; 'push'-opertion follows shortly afterwards
              this.temperature_values.labels.shift();
              this.temperature_values.DHT22_celsius.shift();
            }
            this.push('temperature_values.labels', label);
            this.push('temperature_values.DHT22_celsius', json.celsius);
          }
          // update chart
          this.temperature_chart.labels = this.temperature_values.labels;
          this.temperature_chart.datasets[0].data = this.temperature_values.DHT22_celsius;
          this.$.temperature_chart_id.updateChart();


          // sort and put message into right data structure
          if (this.humidity_values.labels[this.humidity_values.labels.length - 1] === label) {
            this._log("Skipping value for an existing label.", json);
          } else {
            this._log("Adding new value.", json);
            if (this.humidity_values.labels.length > this.max_chart_view) {
              // no need to notify 'shift'-operation explicit; 'push'-opertion follows shortly afterwards
              this.humidity_values.labels.shift();
              this.humidity_values.humidity.shift();
            }
            this.push('humidity_values.labels', label);
            this.push('humidity_values.humidity', json.humidity);
          }
          // update chart
          this.humidity_chart.labels = this.humidity_values.labels;
          this.humidity_chart.datasets[0].data = this.humidity_values.humidity;
          this.$.humidity_chart_id.updateChart();

        }
      },
      _updateBMP280Values: function(event) {
        if (event) {
          var json = event.detail.parsedPayload;

          this.set('temperature_values.last_updated', new Date(json.timestamp * 1000));
          this.set('pressure_values.last_updated', new Date(json.timestamp * 1000));
          this.set('altitude_values.last_updated', new Date(json.timestamp * 1000));

          // TODO update altitude

          var label = this._formatTimestamp(json.timestamp);


          // sort and put message into right data structure
          var index = this.temperature_values.labels.length - 1;
          if (this.temperature_values.labels[index] === label) {
            this._log("Overriding value for an existing label.", json);
            this.set('temperature_values.BMP280_celsius.' + index, json.celsius);
          } else {
            this._log("Adding new value.", json);
            if (this.temperature_values.labels.length > this.max_chart_view) {
              // no need to notify 'shift'-operation explicit; 'push'-opertion follows shortly afterwards
              this.temperature_values.labels.shift();
              this.temperature_values.BMP280_celsius.shift();
            }
            this.push('temperature_values.labels', label);
            this.push('temperature_values.BMP280_celsius', json.celsius);
          }

          // update chart
          this.temperature_chart.labels = this.temperature_values.labels;
          this.temperature_chart.datasets[1].data = this.temperature_values.BMP280_celsius;
          this.$.temperature_chart_id.updateChart();


          // sort and put message into right data structure
          if (this.pressure_values.labels[this.pressure_values.labels.length - 1] === label) {
            this._log("Skipping value for an existing label.", json);
          } else {
            this._log("Adding new value.", json);
            if (this.pressure_values.labels.length > this.max_chart_view) {
              // no need to notify 'shift'-operation explicit; 'push'-opertion follows shortly afterwards
              this.pressure_values.labels.shift();
              this.pressure_values.pascal.shift();
            }
            this.push('pressure_values.labels', label);
            this.push('pressure_values.pascal', json.pascal);
          }
          // update chart
          this.pressure_chart.labels = this.pressure_values.labels;
          this.pressure_chart.datasets[0].data = this.pressure_values.pascal;
          this.$.pressure_chart_id.updateChart();






        }
      },
      _updateMQ135Values: function(event) {
        if (event) {
          var json = event.detail.parsedPayload;

          this.set('co2_values.last_updated', new Date(json.timestamp * 1000));
          var label = this._formatTimestamp(json.timestamp);
          // sort and put message into right data structure
          if (this.co2_values.labels[this.co2_values.labels.length - 1] === label) {
            this._log("Skipping value for an existing label.", json);
          } else {
            this._log("Adding new value.", json);
            if (this.co2_values.labels.length > this.max_chart_view) {
              // no need to notify 'shift'-operation explicit; 'push'-opertion follows shortly afterwards
              this.co2_values.labels.shift();
              this.co2_values.co2.shift();
            }
            this.push('co2_values.labels', label);
            this.push('co2_values.co2', json.co2);
          }
          // update chart
          this.co2_chart.labels = this.co2_values.labels;
          this.co2_chart.datasets[0].data = this.co2_values.co2;
          this.$.co2_chart_id.updateChart();
        }
      },
      _updateTestValues: function(event) {
        if (event) {
          var json = event.detail.parsedPayload;

          this.set('test_values.last_updated', new Date(json.timestamp * 1000));
          var label = this._formatTimestamp(json.timestamp);
          // sort and put message into right data structure
          if (this.test_values.labels[this.test_values.labels.length - 1] === label) {
            this._log("Skipping value for an existing label.", json);
          } else {
            this._log("Adding new value.", json);
            if (this.test_values.labels.length > this.max_chart_view) {
              // no need to notify 'shift'-operation explicit; 'push'-opertion follows shortly afterwards
              this.test_values.labels.shift();
              this.test_values.celsiusA.shift();
              this.test_values.celsiusB.shift();
            }
            this.push('test_values.labels', label);
            this.push('test_values.celsiusA', json.celsiusA);
            this.push('test_values.celsiusB', json.celsiusB);
          }
          // update chart
          this.test_chart.labels = this.test_values.labels;
          this.test_chart.datasets[0].data = this.test_values.celsiusA;
          this.test_chart.datasets[1].data = this.test_values.celsiusB;
          this.$.test_chart_id.updateChart();
        }
      },
      /**_arrayItem: function(change, index, path) {
        return this.get(path, change.base[index]);
      },*/
      _getLastItem: function(change) {
        return change.base[change.base.length - 1];
      },
      /**
       * TODO
       */
      _formatTimestamp: function(timestamp) {
        var value = new Date(timestamp * 1000);
        return [this._pad(value.getHours()), this._pad(value.getMinutes()), this._pad(value.getSeconds())].join(':');
      },
      /**
       * TODO
       */
      _pad: function(n) {
        return n < 10 ? '0' + n.toString(10) : n.toString(10);
      },
      /**
       * A wrapper around `console.log`.
       */
      _log: function() {
        if (this.log) {
          console.log.apply(console, arguments);
        }
      },
      /**
       * A wrapper around `console.group`.
       */
      _group: function() {
        if (this.log) {
          console.group.apply(console, arguments);
        }
      },
      /**
       * A wrapper around `console.groupEnd`.
       */
      _groupEnd: function() {
        if (this.log) {
          console.groupEnd.apply(console, arguments);
        }
      }
    });
  </script>
</dom-module>
