<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/app-storage/app-localstorage/app-localstorage-document.html">

<link rel="import" href="../../bower_components/chart-elements/chart-line.html">

<link rel="import" href="chart-widget-behavior.html">
<link rel="import" href="widget-style.html">

<dom-module id="chart-line-widget">
  <template>
    <style include="widget-style">
    </style>
    <div class="last-updated">
      <div>Last updated on [[_getDatetime(lastMessage.parsedPayload.timestamp)]]</div>
    </div>
    <chart-line id="chart_id" data="[[_chart]]" options="[[_chart_options]]"></chart-line>
    <app-localstorage-document key="{{id}}" data="{{_data}}" log></app-localstorage-document-->
  </template>
  <script>
    Polymer({
      is: 'chart-line-widget',
      behaviors: [
        AppBehaviors.ChartWidgetBehavior
      ],
      properties: {
        label: {
          type: String,
          value: null
        },
        lastMessage: {
          type: Object,
          value: null,
          notify: true,
          observer: '_processMessage'
        },
        property: {
          type: String,
          value: null
        },
        _data: {
          type: Object,
          value: function() {
            return {
              labels: [],
              values: []
            };
          },
          notify: true
        },
        _chart: {
          type: Object,
          value: function() {
            return {
              labels: [],
              datasets: [{
                label: null,
                fill: true,
                backgroundColor: "rgba(220,220,220,0.2)",
                borderColor: "rgba(220,220,220,1)",
                borderWidth: 1,
                data: []
              }]
            };
          }
        },
        _chart_options: {
          type: Object,
          value: {
            responsive: true,
            legend: {
              display: true,
              position: 'bottom'
            }
          }
        }
      },
      attached: function() {
        // link properies and chart representation together
        this._chart.datasets[0].label = this.label;
        this._chart.labels = this._data.labels;
        this._chart.datasets[0].data = this._data.values;
      },
      /**
       * process lastMessage with a timestamp and a variable property value
       */
      _processMessage: function(event) {
        if (event) {
          var json = event.parsedPayload;
          var label = this._formatTimestamp(json.timestamp);
          var index = this._extendXAxis(label);
          // assign new value
          this._data.values[index] = json[this.property];
          // update chart
          this.$.chart_id.updateChart();
          this._notifyArrayMutation();
        }
      },
      /**
       * extend x-axis with label
       */
      _extendXAxis: function(label) {
        var index = this._data.labels.lastIndexOf(label);
        // add new label if label isn't assigned so far
        if (index === -1) {
          this._data.labels.push(label);
          // continue data values linear with latest known value
          this._data.values.push(this._data.values[this._data.values.length - 1]);
          // shrink arrays at the beginning if chart line limit is reached
          if (this._data.labels.length > this.chart_line_limit) {
            this._data.labels.shift();
            this._data.values.shift();
          }
          index = this._data.labels.length - 1;
        }
        // return latest index of assigned label
        return index;
      }
    });
  </script>
</dom-module>
