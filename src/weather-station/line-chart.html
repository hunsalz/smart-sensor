<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/app-storage/app-localstorage/app-localstorage-document.html">

<link rel="import" href="../../bower_components/chart-elements/chart-line.html">

<link rel="import" href="line-chart-item.html">
<link rel="import" href="log-behavior.html">

<script src="label.js"></script>

<dom-module id="line-chart">
  <template strip-whitespace>
    <style>
      :host {
        display: inline-block;
        font: inherit;
      }
      chart-line {
        width: 100%;
        height: 100%;
      }
      .last-updated {
        font-size: 0.75em;
        font-weight: 400;
        color: grey;
        text-align: center;
        padding-top: 10px;
        padding-bottom: 10px;
      }
    </style>
    <div class="last-updated">
      <div>Last updated on [[_lastUpdated]]</div>
    </div>
    <chart-line id="chart_id" data="[[_computeChart(labels, datasets)]]" options="[[options]]"></chart-line>
    <app-localstorage-document key="[[id]]" data="{{labels}}" log$={{verbose}}></app-localstorage-document>
  </template>
  <script>
    Polymer({
      is: 'line-chart',
      behaviors: [
        AppBehaviors.LogBehavior
      ],
      properties: {
        labels: {
          type: Array,
          value: function() {
            return [];
          },
          notify: true
        },
        datasets: {
          type: Array,
          value: function() {
            return [];
          },
          notify: true
        },
        options: {
          type: Object,
          value: {
            responsive: true,
            legend: {
              display: true,
              position: 'bottom'
            }
          }
        },
        maxValues: {
          type: Number,
          value: 5
        },
        _lastUpdated: {
          type: Object,
          notify: true
        }
      },
      ready: function() {
        // get all child elements
        var items = this._getAllLineChartItems();
        // setup each child element
        for (var i = 0; i < items.length; i++) {
          // assign an unique id
          items[i].id = this.id + '#' + i;
          // declare basic dataset
          this.datasets[i] = {
            data: []
          };
          // listen to updates from all <line-chart-item> childs
          this.listen(items[i], 'chart-update', '_processUpdates');
        }
      },
      _getAllLineChartItems: function() {
        return this.queryAllEffectiveChildren('line-chart-item');
      },
      /**
       * process chart updates
       */
      _processUpdates: function(event) {
        if (event) {
          // get id of origin event source
          var sourceId = event.detail.id;
          // get all child elements
          var items = this._getAllLineChartItems();
          // notify all siblings to interpolate all lines
          for (var i = 0; i < items.length; i++) {
            if (items[i].id !== sourceId) {
              items[i].interpolate();
            }
          }
          // save latest update
          this._lastUpdated = this.labels[this.labels.length - 1];

          console.log(event);
          console.log(this.labels);
          for (var i = 0; i < this.datasets.length; i++) {
            console.log(this.datasets[i].data);
          }

          // update chart
          this.$.chart_id.updateChart();
        }
      },
      /**
       * return compound object expected by Chart.js
       */
      _computeChart: function(_labels, _datasets) {
        /**
        for (var i = 0; i < _labels.length; i++) {
          _labels[i] = new Label(_labels[i].timestamp);
        }
        */
        return { labels: _labels, datasets: _datasets }
      },
      _computeLabelsId: function(id) {
        return 'labels.' + id;
      },
      _computeDatasetsId: function(id) {
        return 'dataset.' + id;
      }
    });
  </script>
</dom-module>
