<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/app-storage/app-localstorage/app-localstorage-document.html">

<link rel="import" href="../../bower_components/chart-elements/chart-line.html">

<link rel="import" href="line-chart-item.html">
<link rel="import" href="log-behavior.html">

<script src="label.js"></script>

<dom-module id="line-chart">
  <template strip-whitespace>
    <style>
      :host {
        display: inline-block;
        font: inherit;
      }
      chart-line {
        width: 100%;
        height: 100%;
      }
      .last-updated {
        font-size: 0.75em;
        font-weight: 400;
        color: grey;
        text-align: center;
        padding-top: 10px;
        padding-bottom: 10px;
      }
    </style>
    <div class="last-updated">
      <div>Last updated on [[_lastUpdated]]</div>
    </div>
    <chart-line id="chart_id" data="[[_computeChart(labels, datasets)]]" options="[[options]]"></chart-line>
    <app-localstorage-document key="[[id]]" data="{{labels}}" log$={{verbose}}></app-localstorage-document>
  </template>
  <script>
    Polymer({
      is: 'line-chart',
      behaviors: [
        AppBehaviors.LogBehavior
      ],
      properties: {
        labels: {
          type: Array,
          value: function() {
            return [];
          },
          notify: true
        },
        datasets: {
          type: Array,
          value: function() {
            return [];
          },
          notify: true
        },
        options: {
          type: Object,
          value: {
            responsive: true,
            legend: {
              display: true,
              position: 'bottom'
            }
          }
        },
        valueRange: {
          type: Number,
          value: 0
        },
        valueLimit: {
          type: Number,
          value: 5
        },
        _lastUpdated: {
          type: Object,
          notify: true
        }
      },
      ready: function() {
        // get all child elements
        var items = this._getAllLineChartItems();
        // setup each child element
        for (var i = 0; i < items.length; i++) {
          // assign an unique id
          items[i].id = this.id + '#' + i;
          // propagate property settings
          items[i].properties._valueLimit = 5;
          // declare basic dataset with a default config set
          this.datasets[i] = {
            // see http://www.chartjs.org/docs/#line-chart-dataset-structure
            data: [],
            label: 'undefined',
            fill: true,
            backgroundColor: 'rgba(220,220,220,0.2)',
            borderWidth: 1,
            borderColor: 'rgba(220,220,220,1)',
            pointBackgroundColor: 'rgba(220,220,220,1)',
            pointBorderColor: 'rgba(255,255,255,1)',
            // broadcast a value range to all sub-elements
            valueRange: this.valueRange,
            // broadcast a value limit to all sub-elements
            valueLimit: this.valueLimit
          };
          // listen to updates from all <line-chart-item> childs
          this.listen(items[i], 'chart-update', '_processUpdates');
        }
      },
      /**
       * return all <line-chart-item> sub-elements
       **/
      _getAllLineChartItems: function() {
        return this.queryAllEffectiveChildren('line-chart-item');
      },
      /**
       * process chart updates
       */
      _processUpdates: function(event) {
        if (event) {
          // if true force interpolation
          if (event.detail.interpolate) {
            // get id of original event source
            var sourceId = event.detail.id;
            // get all child elements
            var items = this._getAllLineChartItems();
            // notify all siblings to interpolate corresponding lines
            for (var i = 0; i < items.length; i++) {
              if (items[i].id !== sourceId) {
                this._log("Interpolate: " + items[i].id);
                items[i].interpolate();
              }
            }
          }
          // save latest update
          this._lastUpdated = this.labels[this.labels.length - 1];
          // update chart
          this.$.chart_id.updateChart();
        }
      },
      /**
       * return compound object expected by Chart.js
       *
       * computed function is called only once because Polymer doesn't reflect array mutations for this function
       * see https://www.polymer-project.org/1.0/docs/devguide/model-data#override-dirty-check
       */
      _computeChart: function(_labels, _datasets) {
        // recreate label objects from serialized JSON objects
        for (var i = 0; i < _labels.length; i++) {
          _labels[i] = new Label(_labels[i].timestamp);
        }
        return { labels: _labels, datasets: _datasets }
      }
    });
  </script>
</dom-module>
