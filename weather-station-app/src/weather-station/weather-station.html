<link rel="import" href="../../bower_components/polymer/polymer-element.html">

<link rel="import" href="../../bower_components/app-layout/app-layout.html">
<link rel="import" href="../../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">

<link rel="import" href="../../bower_components/iron-icons/hardware-icons.html">
<link rel="import" href="../../bower_components/iron-icons/image-icons.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">

<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-styles/color.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">

<link rel="import" href="../../bower_components/firebase-element/firebase-app.html">
<link rel="import" href="../../bower_components/firebase-element/firebase-auth.html">

<link rel="import" href="widget-layout.html">
<link rel="import" href="bmp280-widget.html">
<link rel="import" href="dht22-widget.html">
<link rel="import" href="mq135-widget.html">
<link rel="import" href="hardware-widget.html">

<dom-module id="weather-station">
  <template strip-whitespace>
    <style include="app-grid-style">
      :host {
        display: block;
        @apply --paper-font-common-base;
        --app-grid-columns: 2;
        --app-grid-item-height: 100%;
        --app-grid-gutter: 5px;
      }

      app-header {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 30vh;
        color: white;
        background-color: var(--paper-blue-500);
        z-index: 1;
      }

      [main-title] {
        font-size: 1.5em;
        font-weight: bold;
      }

      [condensed-title] {
        font-size: 1em;
        font-weight: normal;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      @media screen and (orientation: landscape) {
        app-toolbar.tall {
          height: 10vh;
        }
      }

      @media screen and (orientation: portrait) {
        app-toolbar.tall {
          height: 30vh;
        }
      }

      @media screen and (min-width: 1200px) {
        :host {
          --app-grid-columns: 3;
        }
      }

      @media screen and (max-width: 700px) {
        :host {
          --app-grid-columns: 1;
        }
      }

      .content-area {
        padding-top: 30vh;
        background-color: white;
      }

      .widget-label {
        margin: 0px 2px 0px 2px;
        padding: 5px 15px 5px 15px;
        border-radius: 20px;
        background-color: var(--paper-red-500);
        color: white;
        font-size: 0.8em;
        font-weight: 500;
        line-height: 1.5em;
        white-space: nowrap;
        @apply --layout-horizontal;
        @apply --layout-center;
      }

      .spacer {
        @apply --layout-flex;
        width: 1vw;
      }
    </style>

    <!-- services -->

    <firebase-app id="app" auto-login name="weather-station" api-key="AIzaSyD0s4sQ6xVcVOLe8TsRcUUiI9aNvED1zKA" auth-domain="weather-station-8266.firebaseapp.com"
      database-url="https://weather-station-8266.firebaseio.com" messaging-sender-id="192040972544" storage-bucket="weather-station-8266.appspot.com">
    </firebase-app>

    <firebase-auth id="auth" app-name="weather-station" on-error="_handleFirebaseAuthError">
    </firebase-auth>

    <!-- service worker -->
    <!--platinum-sw-register skip-waiting
                          clients-claim
                          auto-register
                          reload-on-install>
      <platinum-sw-cache default-cache-strategy="fastest"></platinum-sw-cache>
    </platinum-sw-register-->

    <!-- UI -->
    <app-header-layout fullbleed>
      <!-- header -->
      <app-header condenses fixed effects="resize-title">
        <app-toolbar>
          <div spacer condensed-title>[[app_title]]</div>
          <paper-icon-button icon="{{__isCollapsed(collapsed)}}" on-tap="__toggleAllWidgets"></paper-icon-button>
        </app-toolbar>
        <app-toolbar>
          <div spacer main-title>[[app_title]]</div>
        </app-toolbar>
      </app-header>
      <!-- content area -->
      <div class="content-area">
        <div id="_grid" class="app-grid">
          <widget-layout key="__bmp280">
            <div slot="title">
              <div>Temperature [[temperature1]]°</div>
              <div>Pressure [[pressure]] Pa</div>
              <div>Altitude [[altitude]] m</div>
            </div>
            <div class="widget-label" slot="label">
              <div>BMP280</div>
              <div class="spacer"></div>
              <iron-icon icon="icons:assessment"></iron-icon>
            </div>
            <bmp280-widget temperature="{{temperature1}}" pressure="{{pressure}}" altitude="{{altitude}}"></bmp280-widget>
          </widget-layout>
          <widget-layout key="__dht22">
            <div slot="title">
              <div>Temperature [[temperature2]]°</div>
              <div>Humidity [[humidity]]%</div>
            </div>
            <div class="widget-label" slot="label">
              <div>DHT22</div>
              <div class="spacer"></div>
              <iron-icon icon="icons:assessment"></iron-icon>
            </div>
            <dht22-widget temperature="{{temperature2}}" humidity="{{humidity}}"></dht22-widget>
          </widget-layout>
          <widget-layout key="__mq135">
            <div slot="title">
              <div>CO2 [[ppm]] parts per million (ppm)</div>
            </div>
            <div class="widget-label" slot="label">
              <div>MQ135</div>
              <div class="spacer"></div>
              <iron-icon icon="icons:cloud-queue"></iron-icon>
            </div>
            <mq135-widget ppm="{{ppm}}"></mq135-widget>
          </widget-layout>
          <widget-layout key="__hardware">
            <div slot="title">
              <div>Hardware diagnostics</div>
            </div>
            <div class="widget-label" slot="label">
              <div>ESP8266</div>
              <div class="spacer"></div>
              <iron-icon icon="hardware:devices-other"></iron-icon>
            </div>
            <hardware-widget></hardware-widget>
          </widget-layout>
        </div>
      </div>
    </app-header-layout>
  </template>

  <script>
    class WeatherStation extends Polymer.Element {

      static get is() { return 'weather-station'; }

      static get properties() {
        return {
          app_title: {
            type: String,
            value: 'Weather-Station',
          },
          collapsed: {
            type: Boolean,
            value: true,
            notify: true
          }
        };
      }

      connectedCallback() {
        super.connectedCallback();
        // listen to toggle events from widgets
        this.addEventListener('toggle', e => { this.__applyIconToggle() });
        // listen to window resizing events
        this.__updateGridStyles = this.__updateGridStyles || function () {
          this.updateStyles();
        }.bind(this);
        window.addEventListener('resize', this.__updateGridStyles);
        // apply icon toogle state initially
        this.__applyIconToggle();
      }

      /**
       * true if all widgets are collapsed
       */
      __isCollapsed(collapsed) {
        return collapsed ? 'icons:expand-more' : 'icons:expand-less';
      }

      /**
       * apply icon toggle according to all containing widgets
       */
      __applyIconToggle() {
        // compute toggle state of all <widget-layout> elements
        var nodes = this.$._grid.querySelectorAll('widget-layout');
        var state = 0;
        for (var i = 0; i < nodes.length; i++) {
          state += nodes[i].isCollapsed();
        }
        // switch toggle according to state result
        this.collapsed = state === 0 ? false : true;
      }

      /*
       * toggle all widgets synchronous
       */
      __toggleAllWidgets() {
        // toggle all <widget-layout> elements
        var nodes = this.$._grid.querySelectorAll('widget-layout');
        this.collapsed = !this.collapsed;
        for (var i = 0; i < nodes.length; i++) {
          nodes[i].collapse(this.collapsed);
        }
      }

      __handleFirebaseAuthError(event) {
        console.warn("Firebase auth error: " + event);
      }
    }
    window.customElements.define(WeatherStation.is, WeatherStation);
  </script>
</dom-module>